openapi: 3.0.3
info:
  title: Lamassu VA API
  version: 1.0.0
  description: |
    Validation Authority (VA) API for Lamassu IoT Platform.
    This API provides certificate validation services including OCSP (Online Certificate Status Protocol)
    responses, CRL (Certificate Revocation List) distribution, and VA role management for certificate authorities.
  contact:
    name: Lamassu IoT
    url: https://github.com/lamassuiot/lamassuiot
  license:
    name: Mozilla Public License 2.0
    url: https://github.com/lamassuiot/lamassuiot?tab=MPL-2.0-1-ov-file#readme

servers:
  - url: /api/va/v1
    description: VA API

tags:
  - name: OCSP
    description: Online Certificate Status Protocol operations
  - name: CRL
    description: Certificate Revocation List operations
  - name: VA Roles
    description: VA role management operations

paths:
  /ocsp/{ocsp_request}:
    get:
      tags:
        - OCSP
      summary: Verify certificate status via OCSP (GET method)
      description: |
        Verifies the status of a certificate using OCSP request via HTTP GET method.
        The OCSP request should be base64 encoded and URL-safe.
      operationId: verifyOcspGet
      security: []
      parameters:
        - name: ocsp_request
          in: path
          required: true
          description: Base64 encoded OCSP request
          schema:
            type: string
          example: "MFMwUTBPME0wSzAJBgUrDgMCGgUABBSHCn4TCZLX..."
      responses:
        '200':
          description: OCSP response
          content:
            application/ocsp-response:
              schema:
                type: string
                format: binary
                description: Binary OCSP response data
        '400':
          description: Bad request - invalid OCSP request format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /ocsp:
    post:
      tags:
        - OCSP
      summary: Verify certificate status via OCSP (POST method)
      description: |
        Verifies the status of a certificate using OCSP request via HTTP POST method.
        The OCSP request should be sent in the request body as binary data.
      operationId: verifyOcspPost
      security: []
      requestBody:
        required: true
        content:
          application/ocsp-request:
            schema:
              type: string
              format: binary
              description: Binary OCSP request data
      responses:
        '200':
          description: OCSP response
          content:
            application/ocsp-response:
              schema:
                type: string
                format: binary
                description: Binary OCSP response data
        '400':
          description: Bad request - invalid OCSP request format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /crl/{ca-ski}:
    get:
      tags:
        - CRL
      summary: Get Certificate Revocation List
      description: |
        Retrieves the Certificate Revocation List (CRL) for a specific Certificate Authority
        identified by its Subject Key Identifier (SKI).
      operationId: getCrl
      security: []
      parameters:
        - name: ca-ski
          in: path
          required: true
          description: Certificate Authority Subject Key Identifier (hex encoded)
          schema:
            type: string
          example: "a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0"
      responses:
        '200':
          description: CRL data in DER format
          content:
            application/pkix-crl:
              schema:
                type: string
                format: binary
                description: Binary CRL data in DER format
        '400':
          description: Bad request - invalid CA SKI format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: CRL not found for the specified CA
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /v1/roles/{ca-ski}:
    get:
      tags:
        - VA Roles
      summary: Get VA role by CA SKI
      description: |
        Retrieves the Validation Authority role configuration for a specific Certificate Authority
        identified by its Subject Key Identifier (SKI).
      operationId: getVaRoleById
      parameters:
        - name: ca-ski
          in: path
          required: true
          description: Certificate Authority Subject Key Identifier (hex encoded)
          schema:
            type: string
          example: "a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0"
      responses:
        '200':
          description: VA role configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VARole'
        '400':
          description: Bad request - invalid CA SKI format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: VA role not found for the specified CA
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - VA Roles
      summary: Update VA role
      description: |
        Updates the Validation Authority role configuration for a specific Certificate Authority.
        This includes CRL generation settings and signing configuration.
      operationId: updateVaRole
      parameters:
        - name: ca-ski
          in: path
          required: true
          description: Certificate Authority Subject Key Identifier (hex encoded)
          schema:
            type: string
          example: "a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VARoleUpdate'
      responses:
        '200':
          description: VA role updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VARole'
        '400':
          description: Bad request - invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: VA role not found for the specified CA
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    VARole:
      type: object
      description: Validation Authority role configuration for a Certificate Authority
      properties:
        ca_ski:
          type: string
          description: Certificate Authority Subject Key Identifier (hex encoded)
          example: "a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0"
        crl_options:
          $ref: '#/components/schemas/VACRLRole'
        latest_crl:
          $ref: '#/components/schemas/LatestCRLMeta'

    VACRLRole:
      type: object
      description: CRL generation and management configuration
      properties:
        refresh_interval:
          type: string
          description: |
            Interval between automatic CRL regenerations (duration string format).
            Examples: "1h", "24h", "7d"
          example: "24h"
        validity:
          type: string
          description: |
            Duration for which a generated CRL is valid (duration string format).
            Examples: "1h", "24h", "7d"
          example: "168h"
        subject_key_id_signer:
          type: string
          description: |
            Subject Key Identifier of the key used to sign the CRL (hex encoded).
            This should reference a key from the CA.
          example: "a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0"
        regenerate_on_revoke:
          type: boolean
          description: |
            Whether to automatically regenerate the CRL when a certificate is revoked.
            If true, a new CRL is generated immediately upon certificate revocation.
            If false, CRL is only regenerated based on the refresh_interval.
          example: true

    VARoleUpdate:
      type: object
      description: Request body for updating VA role configuration
      required:
        - refresh_interval
        - validity
        - subject_key_id_signer
        - regenerate_on_revoke
      properties:
        refresh_interval:
          type: string
          description: |
            Interval between automatic CRL regenerations (duration string format).
            Examples: "1h", "24h", "7d"
          example: "24h"
        validity:
          type: string
          description: |
            Duration for which a generated CRL is valid (duration string format).
            Examples: "1h", "24h", "7d"
          example: "168h"
        subject_key_id_signer:
          type: string
          description: |
            Subject Key Identifier of the key used to sign the CRL (hex encoded).
            This should reference a key from the CA.
          example: "a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0"
        regenerate_on_revoke:
          type: boolean
          description: |
            Whether to automatically regenerate the CRL when a certificate is revoked.
          example: true

    LatestCRLMeta:
      type: object
      description: Metadata about the most recently generated CRL
      properties:
        version:
          type: string
          description: CRL version number (as a string to support large integers)
          example: "1"
        valid_from:
          type: string
          format: date-time
          description: Timestamp when the CRL becomes valid
          example: "2025-11-07T10:00:00Z"
        valid_until:
          type: string
          format: date-time
          description: Timestamp when the CRL expires
          example: "2025-11-14T10:00:00Z"

    Error:
      type: object
      properties:
        err:
          type: string
          description: Error message
          example: "VA role not found"

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token authentication

security:
  - BearerAuth: []
